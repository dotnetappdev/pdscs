<!-- Error Message: Only show for general (non-validation) errors -->
<div *ngIf="errorMessage && !selectedPerson" class="error" role="alert" aria-live="assertive">
  <span aria-live="assertive">{{ errorMessage }}</span>
</div>

<!-- Persons Table -->
<main aria-labelledby="persons-list-heading" class="persons-main-layout">
  <h1 id="main-heading" tabindex="0" aria-label="Persons Management" role="heading" aria-level="1" class="visually-hidden">Persons Management</h1>
  <div class="persons-table-form-wrapper">
    <div class="persons-table-container">

      <div id="persons-table-caption" role="note" aria-live="polite" tabindex="0" class="table-caption">List of persons with first name, last name, date of birth, department, and actions</div>
      <div class="table-header-bar">
        <button type="button" (click)="onAdd()" class="ukp-btn ukp-btn-add add-person-btn" aria-label="Add Person">Add Person</button>
        <button type="button" (click)="clearFilters()" class="ukp-btn ukp-btn-cancel clear-filters-btn" [ngClass]="{'mobile': isMobileView}">
          Clear Filters
        </button>
      </div>
      <!-- Only keep the main data table with filters in the header -->
      <table class="table table-responsive persons-table" aria-describedby="persons-list-heading persons-table-caption" role="table">
        <thead role="rowgroup">
          <tr role="row">
            <th *ngIf="isMobileView" scope="col" aria-label="Actions" id="actions-header">Actions</th>
            <th scope="col" aria-label="First Name" id="first-name-header" (click)="setSort('FirstName')" class="sortable align-top">
              <span>First Name</span>
              <span class="sort-arrow" *ngIf="sortColumn === 'FirstName'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
              <div class="filter-input-wrapper">
                <input id="fullNameFilter" type="text" [(ngModel)]="searchText" (ngModelChange)="onSearchChange()" placeholder="Search by name..." aria-label="Search by name" class="filter-input" [ngClass]="{'mobile': isMobileView}" />
              </div>
            </th>
            <th scope="col" aria-label="Last Name" id="last-name-header" (click)="setSort('LastName')" class="sortable">
              <span>Last Name</span>
              <span class="sort-arrow" *ngIf="sortColumn === 'LastName'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
            </th>
            <th scope="col" aria-label="Date of Birth" id="dob-header">Date of Birth</th>
            <th *ngIf="!isMobileView" scope="col" aria-label="Department" id="department-header" class="align-top">
              <span>Department</span>
              <div class="filter-input-wrapper">
                <select [(ngModel)]="selectedDepartmentFilter" (ngModelChange)="onDepartmentFilterChange($event)" aria-label="Filter by department" class="filter-select" [ngClass]="{'mobile': isMobileView}">
                  <option [ngValue]="null">All Departments</option>
                  <option *ngFor="let dept of departments" [ngValue]="dept.Id">{{ dept.Name }}</option>
                </select>
              </div>
            </th>
              <th *ngIf="!isMobileView" scope="col" aria-label="Actions" id="actions-header-desktop" class="align-top text-left">
                <span>Actions</span>
              </th>
          </tr>
        </thead>
        <tbody role="rowgroup">
          <tr *ngIf="pagedPersons.length === 0">
            <td [attr.colspan]="isMobileView ? 5 : 6" class="no-persons-row">No persons found.</td>
          </tr>
          <tr *ngFor="let person of pagedPersons; let i = index" role="row">
            <td *ngIf="isMobileView" role="cell" headers="actions-header">
              <button type="button" (click)="onEdit(person)" class="ukp-btn ukp-btn-edit table-action-btn mobile" [attr.aria-label]="'Edit ' + person.fullName">Edit</button>
              <button type="button" (click)="onDelete(person)" class="ukp-btn ukp-btn-delete table-action-btn mobile" [attr.aria-label]="'Delete ' + person.fullName">Delete</button>
            </td>
            <td role="cell" headers="first-name-header">{{ person.FirstName }}</td>
            <td role="cell" headers="last-name-header">{{ person.LastName }}</td>
            <td role="cell" headers="dob-header">{{ person.DOB ? (person.DOB | date: 'dd/MM/yyyy') : '—' }}</td>
            <td *ngIf="!isMobileView" role="cell" headers="department-header">{{ person.DepartmentName }}</td>
            <td *ngIf="!isMobileView" role="cell" headers="actions-header-desktop">
              <button type="button" (click)="onEdit(person)" class="ukp-btn ukp-btn-edit" [attr.aria-label]="'Edit ' + person.FullName">Edit</button>
              <button type="button" (click)="onDelete(person)" class="ukp-btn ukp-btn-delete" [attr.aria-label]="'Delete ' + person.FullName">Delete</button>
              <app-confirm-delete-modal [show]="showDeleteModal"
                                        [itemName]="selectedPersonToDelete?.FirstName + ' ' + selectedPersonToDelete?.LastName"
                                        (confirm)="confirmDelete()"
                                        (cancel)="cancelDelete()">
              </app-confirm-delete-modal>
            </td>
          </tr>
        </tbody>
      </table>
      <!-- Pagination Controls (below table) -->
      <div class="pagination-bar clearfix">
        <div class="pagination-bar-left" [ngClass]="{'mobile': isMobileView}">
          <select [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange($event)" class="pagination-size-select" aria-label="Select page size">
            <option *ngFor="let size of pageSizeOptions" [value]="size === 0 ? persons.length : size">{{ size === 0 ? 'All' : size }}</option>
          </select>
          <span class="pagination-total">Total: {{ filteredPersons.length }}</span>
        </div>
        <div class="pagination-bar-center" [ngClass]="{'mobile': isMobileView}">
          <button type="button" (click)="goToPage(currentPage - 1)" [disabled]="pageNumbers.length === 1 || currentPage === 1" aria-label="Go to previous page">Previous</button>
          <span class="pagination-pages">
            <button *ngFor="let page of pageNumbers" type="button" (click)="goToPage(page)" [disabled]="pageNumbers.length === 1 || page === currentPage" class="pagination-page-btn" [ngClass]="{'active': page === currentPage}" [attr.aria-label]="'Go to page ' + page">{{ page }}</button>
          </span>
          <button type="button" (click)="goToPage(currentPage + 1)" [disabled]="pageNumbers.length === 1 || currentPage === pageNumbers.length" aria-label="Go to next page">Next</button>
        </div>
        <div class="pagination-bar-clear"></div>
      </div>
      <!-- Add Person button moved above table -->
    </div>
    <!-- Desktop/iPad form floats right -->
    <div *ngIf="selectedPerson && !isMobileView" class="persons-form-container">
      <div class="form-header-bar">
        <h3 class="form-title" tabindex="0" role="heading" aria-level="3" [attr.aria-label]="selectedPerson?.id || selectedPerson?.Id ? 'Edit Person' : 'Add Person'">{{ selectedPerson?.id || selectedPerson?.Id ? 'Edit Person' : 'Add Person' }}</h3>
        <button type="button" (click)="onCancelEdit()" aria-label="Close form" class="form-close-btn" title="Close">
          &times;
        </button>
      </div>
      <form (ngSubmit)="onSave()" #editForm="ngForm" aria-label="Person details form">
        <!-- ...existing code for form fields... -->
        <div class="form-group">
          <label for="FirstName" [ngClass]="{'label-error': fieldErrors['firstName']}" [attr.aria-label]="'First Name'" tabindex="0">
            First Name<span *ngIf="fieldErrors['firstName'] && fieldErrors['firstName'].split(' ')[0] === '*'" class="required-asterisk">*</span>
          </label>
          <input id="FirstName" name="FirstName" [(ngModel)]="selectedPerson.FirstName" required [ngClass]="{'field-error': fieldErrors['firstName'], 'form-input': true}" aria-required="true" [attr.aria-label]="'First Name'" tabindex="0" (input)="onInputChange('firstName')" />
          <div *ngIf="fieldErrors['firstName']">
            <ng-container *ngFor="let err of getErrorMessages(fieldErrors['firstName'])">
              <span *ngIf="err && err.length" class="error error-message">{{ err }}</span>
            </ng-container>
          </div>
        </div>
        <div class="form-group">
          <label for="LastName" [ngClass]="{'label-error': fieldErrors['lastName']}" [attr.aria-label]="'Last Name'" tabindex="0">
            Last Name<span *ngIf="fieldErrors['lastName'] && fieldErrors['lastName'].split(' ')[0] === '*'" class="required-asterisk">*</span>
          </label>
          <input id="LastName" name="LastName" [(ngModel)]="selectedPerson.LastName" required [ngClass]="{'field-error': fieldErrors['lastName'], 'form-input': true}" aria-required="true" [attr.aria-label]="'Last Name'" tabindex="0" (input)="onInputChange('lastName')" />
          <div *ngIf="fieldErrors['lastName']">
            <ng-container *ngFor="let err of getErrorMessages(fieldErrors['lastName'])">
              <span *ngIf="err && err.length" class="error error-message">{{ err }}</span>
            </ng-container>
          </div>
        </div>
        <div class="form-group">
          <label for="dob" [ngClass]="{'label-error': fieldErrors['dob']}" [attr.aria-label]="'Date of Birth'" tabindex="0">
            Date of Birth <span class="date-hint">(dd/mm/yyyy)</span><span *ngIf="fieldErrors['dob'] && fieldErrors['dob'].split(' ')[0] === '*'" class="required-asterisk">*</span>
          </label>
          <input id="dob" name="dob" type="date" [(ngModel)]="selectedPerson.DOB" required [ngClass]="{'field-error': fieldErrors['dob'], 'form-input': true}" aria-required="true" [attr.aria-label]="'Date of Birth'" tabindex="0" />
          <div *ngIf="fieldErrors['dob']">
            <ng-container *ngFor="let err of getErrorMessages(fieldErrors['dob'])">
              <span *ngIf="err && err.length" class="error error-message">{{ err }}</span>
            </ng-container>
          </div>
        </div>
        <div class="form-group">
          <label for="departmentId" [ngClass]="{'label-error': fieldErrors['departmentId']}" [attr.aria-label]="'Department'" tabindex="0">
            Department<span *ngIf="fieldErrors['departmentId'] && fieldErrors['departmentId'].split(' ')[0] === '*'" class="required-asterisk">*</span>
          </label>
          <select id="departmentId" name="departmentId" [(ngModel)]="selectedPerson.DepartmentId" required [ngClass]="{'field-error': fieldErrors['departmentId'], 'form-input': true}" aria-required="true" [attr.aria-label]="'Select department'" tabindex="0">
            <option [ngValue]="null" disabled selected>Please select department...</option>
            <option *ngFor="let dept of departments" [ngValue]="dept.Id">{{ dept.Name }}</option>
          </select>
          <div *ngIf="fieldErrors['departmentId']">
            <ng-container *ngFor="let err of getErrorMessages(fieldErrors['departmentId'])">
              <span *ngIf="err && err.length" class="error error-message">{{ err }}</span>
            </ng-container>
          </div>
        </div>
        <div class="form-group">
          <label for="description" [ngClass]="{'label-error': fieldErrors['description']}" [attr.aria-label]="'Description'" tabindex="0">
            Description<span *ngIf="fieldErrors['description'] && fieldErrors['description'].split(' ')[0] === '*'" class="required-asterisk">*</span>
          </label>
          <textarea id="description" name="description" [(ngModel)]="selectedPerson.Description" rows="4" [ngClass]="{'field-error': fieldErrors['description'], 'form-input': true}" placeholder="Enter description..." maxlength="1000" (input)="onInputChange('description')" aria-required="true" [attr.aria-label]="'Description'" tabindex="0"></textarea>
          <div class="description-length">{{ selectedPerson.Description?.length || 0 }}/1000</div>
          <div *ngIf="fieldErrors['description']">
            <ng-container *ngFor="let err of getErrorMessages(fieldErrors['description'])">
              <span *ngIf="err && err.length" class="error error-message">{{ err }}</span>
            </ng-container>
          </div>
        </div>
        <div class="form-footer">
          <div class="form-note">Note: <span class="required-asterisk">*</span> means required</div>
          <div class="form-actions">
            <button type="submit" class="ukp-btn ukp-btn-save form-action-btn" aria-label="Save person details">Save</button>
            <button type="button" (click)="onCancelEdit()" class="ukp-btn ukp-btn-cancel form-action-btn" aria-label="Cancel editing">Cancel</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Mobile form: always below table, only on mobile -->
    <div *ngIf="selectedPerson && isMobileView" class="persons-form-container-mobile">
      <h3 class="form-title" tabindex="0" role="heading" aria-level="3" [attr.aria-label]="selectedPerson?.id || selectedPerson?.Id ? 'Edit Person' : 'Add Person'">{{ selectedPerson?.id || selectedPerson?.Id ? 'Edit Person' : 'Add Person' }}</h3>
      <form (ngSubmit)="onSave()" #editFormMobile="ngForm" aria-label="Person details form">
        <!-- ...existing code for form fields (repeat as above)... -->
        <div class="form-group">
          <label for="FirstNameMobile" [ngClass]="{'label-error': fieldErrors['firstName']}" [attr.aria-label]="'First Name'" tabindex="0">
            First Name<span *ngIf="fieldErrors['firstName'] && fieldErrors['firstName'].split(' ')[0] === '*'" class="required-asterisk">*</span>
          </label>
          <input id="FirstNameMobile" name="FirstName" [(ngModel)]="selectedPerson.FirstName" required [ngClass]="{'field-error': fieldErrors['firstName'], 'form-input': true}" aria-required="true" [attr.aria-label]="'First Name'" tabindex="0" (input)="onInputChange('firstName')" />
          <div *ngIf="fieldErrors['firstName']">
            <ng-container *ngFor="let err of getErrorMessages(fieldErrors['firstName'])">
              <span *ngIf="err && err.length" class="error error-message">{{ err }}</span>
            </ng-container>
          </div>
        </div>
        <div class="form-group">
          <label for="LastNameMobile" [ngClass]="{'label-error': fieldErrors['lastName']}" [attr.aria-label]="'Last Name'" tabindex="0">
            Last Name<span *ngIf="fieldErrors['lastName'] && fieldErrors['lastName'].split(' ')[0] === '*'" class="required-asterisk">*</span>
          </label>
          <input id="LastNameMobile" name="LastName" [(ngModel)]="selectedPerson.LastName" required [ngClass]="{'field-error': fieldErrors['lastName'], 'form-input': true}" aria-required="true" [attr.aria-label]="'Last Name'" tabindex="0" (input)="onInputChange('lastName')" />
          <div *ngIf="fieldErrors['lastName']">
            <ng-container *ngFor="let err of getErrorMessages(fieldErrors['lastName'])">
              <span *ngIf="err && err.length" class="error error-message">{{ err }}</span>
            </ng-container>
          </div>
        </div>
        <div class="form-group">
          <label for="dobMobile" [ngClass]="{'label-error': fieldErrors['dob']}" [attr.aria-label]="'Date of Birth'" tabindex="0">
            Date of Birth <span class="date-hint">(dd/mm/yyyy)</span><span *ngIf="fieldErrors['dob'] && fieldErrors['dob'].split(' ')[0] === '*'" class="required-asterisk">*</span>
          </label>
          <input id="dobMobile" name="dob" type="date" [(ngModel)]="selectedPerson.DOB" required [ngClass]="{'field-error': fieldErrors['dob'], 'form-input': true}" aria-required="true" [attr.aria-label]="'Date of Birth'" tabindex="0" />
          <div *ngIf="fieldErrors['dob']">
            <ng-container *ngFor="let err of getErrorMessages(fieldErrors['dob'])">
              <span *ngIf="err && err.length" class="error error-message">{{ err }}</span>
            </ng-container>
          </div>
        </div>
        <div class="form-group">
          <label for="departmentIdMobile" [ngClass]="{'label-error': fieldErrors['departmentId']}" [attr.aria-label]="'Department'" tabindex="0">
            Department<span *ngIf="fieldErrors['departmentId'] && fieldErrors['departmentId'].split(' ')[0] === '*'" class="required-asterisk">*</span>
          </label>
          <select id="departmentIdMobile" name="departmentId" [(ngModel)]="selectedPerson.DepartmentId" required [ngClass]="{'field-error': fieldErrors['departmentId'], 'form-input': true}" aria-required="true" [attr.aria-label]="'Select department'" tabindex="0">
            <option [ngValue]="null" disabled selected>Please select department...</option>
            <option *ngFor="let dept of departments" [ngValue]="dept.Id">{{ dept.Name }}</option>
          </select>
          <div *ngIf="fieldErrors['departmentId']">
            <ng-container *ngFor="let err of getErrorMessages(fieldErrors['departmentId'])">
              <span *ngIf="err && err.length" class="error error-message">{{ err }}</span>
            </ng-container>
          </div>
        </div>
        <div class="form-group">
          <label for="descriptionMobile" [ngClass]="{'label-error': fieldErrors['description']}" [attr.aria-label]="'Description'" tabindex="0">
            Description<span *ngIf="fieldErrors['description'] && fieldErrors['description'].split(' ')[0] === '*'" class="required-asterisk">*</span>
          </label>
          <textarea id="descriptionMobile" name="description" [(ngModel)]="selectedPerson.Description" rows="4" [ngClass]="{'field-error': fieldErrors['description'], 'form-input': true}" placeholder="Enter description..." maxlength="1000" (input)="onInputChange('description')" aria-required="true" [attr.aria-label]="'Description'" tabindex="0"></textarea>
          <div class="description-length">{{ selectedPerson.Description?.length || 0 }}/1000</div>
          <div *ngIf="fieldErrors['description']">
            <ng-container *ngFor="let err of getErrorMessages(fieldErrors['description'])">
              <span *ngIf="err && err.length" class="error error-message">{{ err }}</span>
            </ng-container>
          </div>
        </div>
        <div class="form-footer">
          <div class="form-note">Note: <span class="required-asterisk">*</span> means required</div>
          <div class="form-actions">
            <button type="submit" class="ukp-btn ukp-btn-save form-action-btn" aria-label="Save person details">Save</button>
            <button type="button" (click)="onCancelEdit()" class="ukp-btn ukp-btn-cancel form-action-btn" aria-label="Cancel editing">Cancel</button>
          </div>
        </div>
      </form>
    </div>
    <ng-template #noData>
      <p role="note" aria-live="polite" tabindex="0" class="no-persons-available">No persons available.</p>
    </ng-template>
  <!-- End persons table section -->
</div> <!-- close persons-table-form-wrapper -->
<aside aria-label="Notifications and messages">
  <app-toast [show]="showToast" [message]="toastMessage"></app-toast>
</aside>
</main>

