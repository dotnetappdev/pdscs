
<aside aria-labelledby="toast-heading">
  <h2 id="toast-heading" class="visually-hidden">Toast notification panel</h2>
  <app-toast [show]="showToast" [message]="toastMessage"></app-toast>
</aside>

<main aria-labelledby="departments-list-heading" class="departments-main">
  <h1 id="main-heading-dpcom" class="visually-hidden">Departments Management</h1>
  <div class="departments-table-form-wrapper">
    <div class="departments-table-panel">
      <!-- All table and related content here (from original left column) -->
      <div class="departments-table-header-block">
        <h2 id="departments-list-heading" class="departments-list-heading">
          Departments List
        </h2>
        <div class="add-department-btn-row">
          <button type="button" (click)="onAdd()" class="ukp-btn ukp-btn-add" aria-label="Add Department">
            Add Department
          </button>
        </div>
      </div>
      <aside aria-label="Error messages">
        <div *ngIf="errorMessage" class="error error-message" role="alert" aria-live="assertive" tabindex="0">
          {{ errorMessage }}
        </div>
      </aside>
      <div class="departments-table-filter-row">
        <!-- Filter moved into table below -->
      </div>
      <table class="table table-responsive departments-table" aria-describedby="departments-list-heading" role="table">
        <caption id="departments-table-caption">List of departments with name and actions</caption>
        <thead role="rowgroup" class="departments-table-thead">
          <tr role="row">
            <th scope="col" aria-label="Department Name" id="departments-table-name-header" (click)="toggleSortDirection()" class="departments-table-th-name">
              <span id="departments-table-name-label">Name</span>
              <span class="departments-table-sort-arrow">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
            </th>
            <th scope="col" aria-label="Actions" id="departments-table-actions-header" class="departments-table-th-actions">Actions</th>
          </tr>
          <tr>
            <td class="departments-table-filter-cell" colspan="1">
              <input type="text" [(ngModel)]="departmentNameFilter" (ngModelChange)="onDepartmentNameFilterChange()" placeholder="Filter by department name..." aria-label="Filter by department name"
                class="departments-table-filter-input" />
            </td>
            <td class="departments-table-filter-empty"></td>
          </tr>
        </thead>
        <tbody role="rowgroup">
          <tr *ngIf="filteredDepartments.length === 0">
            <td colspan="2" class="departments-table-no-data">No departments found.</td>
          </tr>
          <tr *ngFor="let dept of pagedDepartments" role="row" class="departments-table-row">
            <td role="cell" headers="departments-table-name-header" class="departments-table-td-name">{{ dept.Name }}</td>
            <td role="cell" headers="departments-table-actions-header" class="departments-table-td-actions">
              <div class="department-actions-row">
                <button type="button" (click)="onEdit(dept)" class="ukp-department-edit" [attr.aria-label]="'Edit department ' + dept.Name">Edit</button>
                <ng-container *ngIf="hasPersons(dept); else deleteEnabledBlock">
                  <button type="button"
                    (click)="confirmDelete(dept)"
                    class="ukp-department-delete"
                    [disabled]="true"
                    [attr.aria-label]="'Delete department ' + dept.Name">Delete</button>
                </ng-container>
                <ng-template #deleteEnabledBlock>
                  <button type="button"
                    (click)="confirmDelete(dept)"
                    class="ukp-department-delete"
                    [disabled]="false"
                    [attr.aria-label]="'Delete department ' + dept.Name">Delete</button>
                </ng-template>
                <span class="view-persons-cell">
                  <ng-container *ngIf="hasPersons(dept); else noPersonsBlock">
                    <button type="button" (click)="viewPersons(dept)" class="ukp-department-view" [attr.aria-label]="'View persons in department ' + dept.Name">Persons</button>
                  </ng-container>
                  <ng-template #noPersonsBlock>
                    <button type="button" class="ukp-department-nopersons" disabled>Persons</button>
                  </ng-template>
                </span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <!-- Pagination Controls (outside table, responsive, like persons) -->
      <div class="pagination-bar clearfix">
        <div class="pagination-bar-inner" [class.mobile-view]="isMobileView">
          <div class="pagination-bar-select">
            <select [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange($event)" class="pagination-bar-select-input" aria-label="Select page size">
              <option *ngFor="let size of pageSizeOptions" [value]="size === 0 ? filteredDepartments.length : size">{{ size === 0 ? 'All' : size }}</option>
            </select>
            <span class="pagination-bar-total">Total: {{ filteredDepartments.length }}</span>
          </div>
          <div class="pagination-bar-controls" [class.mobile-margin]="isMobileView">
            <button type="button" (click)="goToPage(currentPage - 1)" [disabled]="pageNumbers.length === 1 || currentPage === 1" aria-label="Go to previous page">Previous</button>
            <span class="pagination-bar-pages">
              <button *ngFor="let page of pageNumbers" type="button" (click)="goToPage(page)" [disabled]="pageNumbers.length === 1 || page === currentPage" [ngClass]="{ 'active-page': page === currentPage }" [attr.aria-label]="'Go to page ' + page">{{ page }}</button>
            </span>
            <button type="button" (click)="goToPage(currentPage + 1)" [disabled]="pageNumbers.length === 1 || currentPage === pageNumbers.length" aria-label="Go to next page">Next</button>
          </div>
        </div>
      </div>
      <app-confirm-delete-modal [show]="showDeleteModal"
                                [itemName]="deleteDepartmentTarget?.Name || ''"
                                (confirm)="deleteDepartment()"
                                (cancel)="cancelDelete()"
                                aria-label="Confirm delete department modal"
                                role="dialog"
                                aria-modal="true">
      </app-confirm-delete-modal>
    
    </div>
    <div *ngIf="selectedDepartment && !showPersonsPanel" class="department-form-panel">
      <div class="department-form-header">
        <h3 class="department-form-title" tabindex="0">
          {{ selectedDepartment.Id ? 'Edit Department' : 'Add Department' }}
        </h3>
        <!-- Close button removed from edit form header as requested -->
      </div>
      <form (ngSubmit)="onSave()" aria-label="Department details form">
        <div class="department-form-group">
          <label for="departmentName" id="name-label" [ngClass]="{'department-form-label-error': errorMessage === 'Department name cannot be blank.'}" tabindex="0">
            Department Name<span *ngIf="errorMessage === 'Department name cannot be blank.'" class="department-form-label-required">*</span>
          </label>
          <input id="departmentName" name="name" [(ngModel)]="selectedDepartment.Name" required
                 [ngClass]="{'field-error': fieldErrors['Name'], 'department-form-input': true}"
                 aria-required="true" tabindex="0" />
          <div *ngIf="fieldErrors['Name']" class="department-form-error">
            {{ fieldErrors['Name'] }}
            <span class="department-form-error-note">(Notes * means required field)</span>.
          </div>
        </div>
        <div class="department-form-actions">
          <button type="submit" class="ukp-department-save" aria-label="Save department details">Save</button>
          <button type="button" (click)="onCancelEdit()" class="ukp-department-cancel" aria-label="Cancel editing">Cancel</button>
        </div>
      </form>
    </div>

    <div *ngIf="showPersonsPanel" class="department-form-panel">
      <div class="department-form-header">
        <h3 class="department-form-title" tabindex="0">Persons in Department</h3>
      </div>
      <ul *ngIf="personsInDepartment.length > 0; else noPersonsPanel">
        <li *ngFor="let person of personsInDepartment">{{ person.FirstName }} {{ person.LastName }}</li>
      </ul>
      <ng-template #noPersonsPanel>
        <p>No persons in this department.</p>
      </ng-template>
      <div class="persons-panel-close-row">
        <button type="button" (click)="closePersonsPanel()" class="ukp-department-edit" aria-label="Close persons panel">Close</button>
      </div>
    </div>

    <ng-template #noData>
      <p role="note" aria-live="polite" tabindex="0">No departments available.</p>
    </ng-template>


