<h2 id="departments-list-heading" tabindex="0" aria-label="Departments List" style="font-size:1.5rem; color:#373151; margin-bottom:1rem;">Departments</h2>
<div *ngIf="errorMessage" class="error" role="alert" aria-live="assertive" tabindex="0" style="color:#c00; margin-bottom:1rem;">{{ errorMessage }}</div>
<div aria-labelledby="departments-list-heading" style="display:flex; gap:2rem; align-items:flex-start; flex-wrap:wrap; min-height:calc(100vh - 120px); margin-top:0; position:relative;">
  <div style="flex:2; min-width:125PX;">
    <table *ngIf="departments.length > 0; else noData" class="table table-responsive" aria-describedby="departments-list-heading" style="font-size:0.95rem; min-width:320px; max-width:480px; width:auto; border-collapse:collapse; background:#fff; box-shadow:0 2px 8px rgba(44,42,41,0.08); margin-left:0; border:1px solid #ccc;" role="table">
      <caption id="departments-table-caption">List of departments with name and actions</caption>
      <thead role="rowgroup" style="background:#f8f8fa;">
        <tr role="row">
          <th scope="col" aria-label="Department Name" id="name-header" (click)="toggleSortDirection()" style="cursor:pointer; padding:0.5rem 0.5rem; border-bottom:2px solid #e0c7d1; border-right:1px solid #ccc; color:#373151; font-weight:600; width:1%; min-width:120px; max-width:180px; white-space:nowrap;">
            <span>Name</span>
            <span style="font-size:1rem; margin-left:0.25rem;">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
          </th>
          <th scope="col" aria-label="Actions" id="actions-header" style="padding:0.5rem 0.25rem; border-bottom:2px solid #e0c7d1; border-right:1px solid #ccc; color:#373151; font-weight:600; width:1%; min-width:140px; max-width:70px; text-align:center; white-space:nowrap;">Actions</th>
        </tr>
      </thead>
      <tbody role="rowgroup">
        <tr *ngFor="let dept of departments" role="row" style="border-bottom:1px solid #e0c7d1;">
          <td role="cell" headers="name-header" style="padding:0.5rem 0.5rem; border-bottom:1px solid #e0c7d1; border-right:1px solid #ccc; width:1%; min-width:120px; max-width:180px; white-space:nowrap;">{{ dept.Name }}</td>
          <td role="cell" headers="actions-header" style="padding:0.5rem 0.25rem; text-align:center; border-right:1px solid #ccc; width:1%; min-width:56px; max-width:70px; border-bottom:1px solid #e0c7d1; white-space:nowrap;">
            <button type="button" (click)="onEdit(dept)" class="ukp-btn ukp-btn-edit" [attr.aria-label]="'Edit ' + dept.Name" style="font-size:0.95rem; padding:0.25rem 0.75rem; margin-right:0.25rem; background:#373151; color:#fff; border:none; border-radius:4px; cursor:pointer;">Edit</button>
            <button type="button" (click)="viewPersons(dept)" class="ukp-btn ukp-btn-view" [attr.aria-label]="'View persons in ' + dept.Name" style="font-size:0.95rem; padding:0.25rem 0.5rem; margin-right:0.25rem; background:#43a047; color:#fff; border:none; border-radius:4px; cursor:pointer;">View Persons</button>
            <button type="button"
              (click)="confirmDelete(dept)"
              class="ukp-btn ukp-btn-delete"
              [disabled]="hasPersons(dept)"
              [ngStyle]="{ opacity: hasPersons(dept) ? 0.5 : 1 }"
              [attr.aria-label]="'Delete ' + dept.Name"
              style="font-size:0.95rem; padding:0.25rem 0.5rem; background:#c00; color:#fff; border:none; border-radius:4px; cursor:pointer;">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>

    <app-confirm-delete-modal
      [show]="showDeleteModal"
      [itemName]="selectedDepartment?.Name || ''"
      (confirm)="deleteDepartment()"
      (cancel)="cancelDelete()"
      aria-label="Confirm delete department modal"
      role="dialog"
      aria-modal="true">
    </app-confirm-delete-modal>

    <div *ngIf="showPersonsModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="persons-modal-title">
      <div class="modal-content">
        <h3 id="persons-modal-title">Persons in Department</h3>
        <ul *ngIf="personsInDepartment.length > 0; else noPersons">
          <li *ngFor="let person of personsInDepartment">{{ person.FirstName }} {{ person.LastName }}</li>
        </ul>
        <ng-template #noPersons>
          <p>No persons in this department.</p>
        </ng-template>
        <div class="modal-actions">
          <button type="button" (click)="closePersonsModal()" class="ukp-btn ukp-btn-cancel" aria-label="Close persons modal">Close</button>
        </div>
      </div>
    </div>
    <ng-template #noData>
      <p role="note" aria-live="polite" tabindex="0">No departments available.</p>
    </ng-template>
    <button type="button" (click)="onAdd()" class="ukp-btn ukp-btn-add" style="margin-top:1rem; font-size:0.95rem; padding:0.25rem 0.75rem; background:#43a047; color:#fff; border:none; border-radius:4px; cursor:pointer;" aria-label="Add Department">Add Department</button>
  </div>
  <div *ngIf="selectedDepartment" style="flex:1; min-width:300px; max-width:400px; border-left:1px solid #ccc; padding-left:2rem; font-size:0.95rem; background:#f8f8fa;">
    <form (ngSubmit)="onSave()" aria-label="Department details form">
      <div style="margin-bottom: 1.5rem;">
        <label for="departmentName" id="name-label" [ngStyle]="{ color: errorMessage === 'Department name cannot be blank.' ? '#c00' : '#373151', 'font-size':'1rem', 'font-weight':'500' }" [attr.aria-label]="'Department Name'" tabindex="0">
          Department Name<span *ngIf="errorMessage === 'Department name cannot be blank.'" style="color:#c00;">*</span>
        </label>
        <input id="departmentName" name="name" [(ngModel)]="selectedDepartment.Name" required
          [ngClass]="{'field-error': fieldErrors['Name']}"
          style="width:100%; font-size:1rem; margin-bottom:0.25rem; border:1px solid; border-radius:4px; padding:0.5rem;"
          aria-required="true" [attr.aria-label]="'Department Name'" tabindex="0" />
        <div *ngIf="fieldErrors['Name']" style="color:#c00; font-size:0.95rem; margin-bottom:0.5rem;">
          {{ fieldErrors['Name'] }}
          <span style="font-weight:normal; color:red;">(Notes * means required field)</span>.
        </div>
      </div>
      <div style="margin-top:1rem; display:flex; gap:1rem;">
        <button type="submit" class="ukp-btn ukp-btn-save" style="font-size:1rem; padding:0.5rem 1.5rem; background:#373151; color:#fff; border:none; border-radius:4px; cursor:pointer;" aria-label="Save department details">Save</button>
        <button type="button" (click)="onCancelEdit()" class="ukp-btn ukp-btn-cancel" style="font-size:1rem; padding:0.5rem 1.5rem; background:#e0c7d1; color:#373151; border:none; border-radius:4px; cursor:pointer;" aria-label="Cancel editing">Cancel</button>
      </div>
    </form>
  </div>
  <app-toast [show]="showToast" [message]="toastMessage"></app-toast>
</div>
